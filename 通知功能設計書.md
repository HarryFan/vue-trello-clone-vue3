# 通知功能設計書 (Notification Design)

🎯 目的
設計簡單有效的通知機制，讓 Trello Clone 前端應用程式可以透過 Notification API 發出到期提醒。

📋 本次專案定義
本專案為內部練習專案，預算及資源有限。

僅實作「前端費時循環（Polling）」方式。

暫不導入複雜的後端推播機制。

🛠️ 通知框架概要
1. 前端設計
  - 透過定時器，每隔固定秒數（如 30 秒）呼叫後端 API。
  - 分析回傳資料，找出即將到期的任務（依 deadline 欄位判斷）。
  - 利用 Notification API 直接推播到使用者裝置。
  - 需考量使用者權限授權 Notification API（如第一次使用需請求權限）。

2. 後端設計
  - 提供一個 API：/api/notifications/upcoming
  - 根據使用者身份，回傳「即將到期」的任務資料。
  - 回傳資料格式：
    ```json
    {
      "success": true,
      "data": [
        {
          "id": 1001,
          "title": "寫 API 規格",
          "deadline": "2025-04-30T23:59:59",
          "list_title": "進行中",
          "board_id": 1
        }
      ]
    }
    ```
  - 篩選條件：以系統時間為基準，取出未來 X 分鐘內（如 10 分鐘）即將到期的任務。
  - 無需額外推播服務，由前端定期自行拉取。

📝 具體實作細節

1. 前端通知服務 (NotificationService)
```javascript
// services/notificationService.js
export class NotificationService {
  constructor() {
    this.checkPermission()
    this.pollingInterval = 30000 // 30秒
    this.timer = null
  }

  // 檢查通知權限
  async checkPermission() {
    if (!('Notification' in window)) {
      console.warn('此瀏覽器不支援通知功能')
      return false
    }

    if (Notification.permission === 'granted') {
      return true
    }

    if (Notification.permission !== 'denied') {
      const permission = await Notification.requestPermission()
      return permission === 'granted'
    }

    return false
  }

  // 開始輪詢
  startPolling() {
    if (this.timer) return
    this.checkUpcoming()
    this.timer = setInterval(() => this.checkUpcoming(), this.pollingInterval)
  }

  // 停止輪詢
  stopPolling() {
    if (this.timer) {
      clearInterval(this.timer)
      this.timer = null
    }
  }

  // 檢查即將到期任務
  async checkUpcoming() {
    try {
      const response = await fetch('/api/notifications/upcoming')
      const { data } = await response.json()
      
      data.forEach(task => {
        this.showNotification(task)
      })
    } catch (error) {
      console.error('檢查到期任務失敗:', error)
    }
  }

  // 顯示通知
  showNotification(task) {
    if (Notification.permission !== 'granted') return

    const notification = new Notification('任務即將到期', {
      body: `${task.title} (在 ${task.list_title} 清單中)`,
      icon: '/favicon.ico',
      tag: `task-${task.id}`, // 避免重複通知
      data: {
        boardId: task.board_id,
        taskId: task.id
      }
    })

    notification.onclick = () => {
      window.focus()
      // 導航到對應的任務卡片
      router.push(`/board/${task.board_id}?task=${task.id}`)
    }
  }
}
```

2. 後端 API 實作 (CodeIgniter)
```php
// app/Controllers/Notifications.php
class Notifications extends BaseController {
  public function upcoming() {
    $userId = $this->getUserId(); // 從 JWT 取得
    $minutes = 10; // 未來 10 分鐘內到期的任務
    
    $model = new CardModel();
    $tasks = $model->getUpcomingTasks($userId, $minutes);
    
    return $this->respond([
      'success' => true,
      'data' => $tasks
    ]);
  }
}

// app/Models/CardModel.php
class CardModel extends Model {
  public function getUpcomingTasks($userId, $minutes) {
    $now = date('Y-m-d H:i:s');
    $future = date('Y-m-d H:i:s', strtotime("+{$minutes} minutes"));
    
    return $this->db->table('cards c')
      ->select('c.id, c.title, c.deadline, l.title as list_title, b.id as board_id')
      ->join('lists l', 'l.id = c.list_id')
      ->join('boards b', 'b.id = l.board_id')
      ->where('b.user_id', $userId)
      ->where('c.deadline >=', $now)
      ->where('c.deadline <=', $future)
      ->get()
      ->getResultArray();
  }
}
```

3. 整合到 Vue 應用程式
```javascript
// main.js 或 App.vue
import { NotificationService } from '@/services/notificationService'

const notificationService = new NotificationService()

// 當用戶登入後啟動通知服務
onMounted(() => {
  if (isAuthenticated.value) {
    notificationService.startPolling()
  }
})

// 當用戶登出時停止通知服務
onUnmounted(() => {
  notificationService.stopPolling()
})
```

🔮 未來展望（若商業化時）
若專案規模擴大或有商業化需求，建議採用更專業的通知機制：

- 導入 Firebase Cloud Messaging (FCM) 等推播服務
- 後端主動發送通知，實現即時性通知
- 管理裝置 Token、訊息隊列等
- 支援 Web Push、Mobile Push 等多端同步
- 增加更多通知類型（如：評論、提及、分享等）
- 支援通知偏好設定（頻率、類型等）
- 實作通知歷史記錄功能

📌 編說
本設計以「最小可行產品 (MVP)」為優先目標。

適合小型、低成本、快速開發。

若日後升級，需重新規劃通知系統架構。

主要功能：
1. ✅ 支援瀏覽器原生通知
2. ✅ 自動檢查即將到期任務
3. ✅ 點擊通知可跳轉至對應任務
4. ✅ 避免重複通知同一任務
5. ✅ 考慮使用者權限管理
6. ✅ 整合現有身份驗證機制
