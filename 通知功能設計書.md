# é€šçŸ¥åŠŸèƒ½è¨­è¨ˆæ›¸ (Notification Design)

ğŸ¯ ç›®çš„
è¨­è¨ˆç°¡å–®æœ‰æ•ˆçš„é€šçŸ¥æ©Ÿåˆ¶ï¼Œè®“ Trello Clone æ‡‰ç”¨ç¨‹å¼å¯ä»¥é€é Notification API ç™¼å‡ºåˆ°æœŸæé†’åŠé›»å­éƒµä»¶é€šçŸ¥ã€‚

ğŸ“‹ æœ¬æ¬¡å°ˆæ¡ˆå®šç¾©
æœ¬å°ˆæ¡ˆç‚ºå…§éƒ¨ç·´ç¿’å°ˆæ¡ˆï¼Œé ç®—åŠè³‡æºæœ‰é™ã€‚

å¯¦ä½œã€Œå‰ç«¯è²»æ™‚å¾ªç’°ï¼ˆPollingï¼‰ã€æ–¹å¼çš„ç€è¦½å™¨é€šçŸ¥ã€‚
æ–°å¢ã€Œé›»å­éƒµä»¶æé†’ã€åŠŸèƒ½ï¼Œæ–¼ä»»å‹™å³å°‡åˆ°æœŸæ™‚ç™¼é€æé†’éƒµä»¶ã€‚

## ğŸš€ å¯¦ç¾ç‹€æ…‹èˆ‡é€²åº¦

### å·²å®ŒæˆåŠŸèƒ½
- âœ… ç€è¦½å™¨å…§éƒ¨é€šçŸ¥ - ä½¿ç”¨é é¢å…§é¡¯ç¤ºçš„é€šçŸ¥å¡ç‰‡
- âœ… ç€è¦½å™¨åŸç”Ÿé€šçŸ¥ - ä½¿ç”¨ Notification APIï¼ˆéœ€æˆæ¬Šï¼‰
- âœ… å³å°‡åˆ°æœŸä»»å‹™æª¢æ¸¬ - å‰ç«¯å®šæ™‚æŸ¥è©¢å¾Œç«¯ API
- âœ… é€šçŸ¥çš„ã€Œå·²è®€ã€åŠŸèƒ½ - ç”¨æˆ¶å¯é»æ“Šå·²è®€æŒ‰éˆ•é—œé–‰é€šçŸ¥

### å¾…å®ŒæˆåŠŸèƒ½
- âš ï¸ **é›»å­éƒµä»¶é€šçŸ¥** - å·²å®Œæˆç¨‹å¼ç¢¼å¯¦ç¾ï¼Œä½†ç”±æ–¼æœ¬åœ°ç’°å¢ƒé™åˆ¶ï¼Œå°šæœªèƒ½å¯¦éš›æ¸¬è©¦
  - åŸå› ï¼šæœ¬æ©Ÿç’°å¢ƒé›£ä»¥é…ç½® SMTP æœå‹™
  - å»ºè­°ï¼šéƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒå¾Œå†é€²è¡Œæ¸¬è©¦èˆ‡æœ€çµ‚èª¿æ•´
  - å¯¦ç¾ç‹€æ…‹ï¼šç¨‹å¼ç¢¼å·²å®Œæˆï¼Œä½†æœªç¢ºèªåŠŸèƒ½å¯ç”¨æ€§

- ğŸ”„ é€šçŸ¥åå¥½è¨­å®šä»‹é¢ - å·²è¨­è¨ˆä½†å°šæœªå®Œå…¨æ•´åˆåˆ°å‰ç«¯

ğŸ› ï¸ é€šçŸ¥æ¡†æ¶æ¦‚è¦
1. å‰ç«¯è¨­è¨ˆ
  - é€éå®šæ™‚å™¨ï¼Œæ¯éš”å›ºå®šç§’æ•¸ï¼ˆå¦‚ 30 ç§’ï¼‰å‘¼å«å¾Œç«¯ APIã€‚
  - åˆ†æå›å‚³è³‡æ–™ï¼Œæ‰¾å‡ºå³å°‡åˆ°æœŸçš„ä»»å‹™ï¼ˆä¾ deadline æ¬„ä½åˆ¤æ–·ï¼‰ã€‚
  - åˆ©ç”¨ Notification API ç›´æ¥æ¨æ’­åˆ°ä½¿ç”¨è€…è£ç½®ã€‚
  - éœ€è€ƒé‡ä½¿ç”¨è€…æ¬Šé™æˆæ¬Š Notification APIï¼ˆå¦‚ç¬¬ä¸€æ¬¡ä½¿ç”¨éœ€è«‹æ±‚æ¬Šé™ï¼‰ã€‚
  - æä¾›é€šçŸ¥åå¥½è¨­å®šé¸é …ï¼Œè®“ä½¿ç”¨è€…å¯é¸æ“‡æ˜¯å¦æ¥æ”¶ç€è¦½å™¨é€šçŸ¥æˆ–é›»å­éƒµä»¶æé†’ã€‚

2. å¾Œç«¯è¨­è¨ˆ
  - æä¾› APIï¼š/api/notifications/upcoming å–å¾—å³å°‡åˆ°æœŸä»»å‹™
  - æä¾› APIï¼š/api/notifications/settings è¨­å®šé€šçŸ¥åå¥½
  - æä¾› APIï¼š/api/notifications/test-email æ¸¬è©¦é›»å­éƒµä»¶æœå‹™
  - å¯¦ä½œæ’ç¨‹ä»»å‹™ï¼Œå®šæœŸæª¢æŸ¥å³å°‡åˆ°æœŸçš„ä»»å‹™ä¸¦ç™¼é€é›»å­éƒµä»¶æé†’
  - å›å‚³è³‡æ–™æ ¼å¼ï¼š
    ```json
    {
      "success": true,
      "data": [
        {
          "id": 1001,
          "title": "å¯« API è¦æ ¼",
          "deadline": "2025-04-30T23:59:59",
          "list_title": "é€²è¡Œä¸­",
          "board_id": 1
        }
      ]
    }
    ```
  - ç¯©é¸æ¢ä»¶ï¼šä»¥ç³»çµ±æ™‚é–“ç‚ºåŸºæº–ï¼Œå–å‡ºæœªä¾† X åˆ†é˜å…§ï¼ˆå¦‚ 10 åˆ†é˜ï¼‰å³å°‡åˆ°æœŸçš„ä»»å‹™ã€‚

ğŸ“ å…·é«”å¯¦ä½œç´°ç¯€

1. å‰ç«¯é€šçŸ¥æœå‹™ (NotificationService)
```javascript
// services/notificationService.js
export class NotificationService {
  constructor() {
    this.checkPermission()
    this.pollingInterval = 30000 // 30ç§’
    this.timer = null
    this.notificationPreference = this.loadPreferences()
  }

  // è¼‰å…¥é€šçŸ¥åå¥½è¨­å®š
  loadPreferences() {
    const preferences = localStorage.getItem('notification_preferences')
    if (preferences) {
      return JSON.parse(preferences)
    }
    return {
      browser: true,
      email: true,
      pollingInterval: 30000,
      emailLeadTime: 60 // é›»å­éƒµä»¶æå‰ 60 åˆ†é˜æé†’
    }
  }

  // å„²å­˜é€šçŸ¥åå¥½è¨­å®š
  savePreferences(preferences) {
    this.notificationPreference = { ...this.notificationPreference, ...preferences }
    localStorage.setItem('notification_preferences', JSON.stringify(this.notificationPreference))
    
    // æ›´æ–°å¾Œç«¯é€šçŸ¥è¨­å®š
    this.updateServerPreferences()
    
    // æ›´æ–°è¼ªè©¢é–“éš”
    if (this.timer) {
      this.stopPolling()
      this.startPolling()
    }
  }
  
  // æ›´æ–°å¾Œç«¯é€šçŸ¥è¨­å®š
  async updateServerPreferences() {
    try {
      await api.post('/api/notifications/settings', this.notificationPreference)
    } catch (error) {
      console.error('æ›´æ–°é€šçŸ¥è¨­å®šå¤±æ•—:', error)
    }
  }

  // æª¢æŸ¥é€šçŸ¥æ¬Šé™
  async checkPermission() {
    if (!('Notification' in window)) {
      console.warn('æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½')
      return false
    }

    if (Notification.permission === 'granted') {
      return true
    }

    if (Notification.permission !== 'denied') {
      const permission = await Notification.requestPermission()
      return permission === 'granted'
    }

    return false
  }

  // é–‹å§‹è¼ªè©¢
  startPolling() {
    if (this.timer) return
    this.checkUpcoming()
    this.timer = setInterval(() => this.checkUpcoming(), 
      this.notificationPreference.pollingInterval || this.pollingInterval)
  }

  // åœæ­¢è¼ªè©¢
  stopPolling() {
    if (this.timer) {
      clearInterval(this.timer)
      this.timer = null
    }
  }

  // æª¢æŸ¥å³å°‡åˆ°æœŸä»»å‹™
  async checkUpcoming() {
    try {
      const response = await api.get('/api/notifications/upcoming')
      const { data } = response.data
      
      if (data && data.length > 0) {
        data.forEach(task => {
          // ç€è¦½å™¨é€šçŸ¥
          if (this.notificationPreference.browser) {
            this.showNotification(task)
          }
        })
      }
    } catch (error) {
      console.error('æª¢æŸ¥åˆ°æœŸä»»å‹™å¤±æ•—:', error)
    }
  }

  // é¡¯ç¤ºé€šçŸ¥
  showNotification(task) {
    if (Notification.permission !== 'granted') return

    const notification = new Notification('ä»»å‹™å³å°‡åˆ°æœŸ', {
      body: `${task.title} (åœ¨ ${task.list_title} æ¸…å–®ä¸­) å°‡æ–¼ ${this.formatDeadline(task.deadline)} åˆ°æœŸ`,
      icon: '/favicon.ico',
      tag: `task-${task.id}`, // é¿å…é‡è¤‡é€šçŸ¥
      data: {
        boardId: task.board_id,
        taskId: task.id
      }
    })

    notification.onclick = () => {
      window.focus()
      // å°èˆªåˆ°å°æ‡‰çš„ä»»å‹™å¡ç‰‡
      router.push(`/board/${task.board_id}?task=${task.id}`)
    }
  }
  
  // æ ¼å¼åŒ–æˆªæ­¢æ—¥æœŸ
  formatDeadline(deadline) {
    if (!deadline) return ''
    const date = new Date(deadline)
    return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
  }
  
  // æ¸¬è©¦é›»å­éƒµä»¶
  async testEmail(email) {
    try {
      emailMessage.value = 'æ­£åœ¨ç™¼é€æ¸¬è©¦éƒµä»¶...'
      emailStatus.value = 'pending'
      
      await api.post('/api/notifications/test-email', { email })
      
      emailMessage.value = 'æ¸¬è©¦éƒµä»¶å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥æ‚¨çš„éƒµç®±'
      emailStatus.value = 'success'
    } catch (error) {
      emailMessage.value = `ç™¼é€å¤±æ•—: ${error.message}`
      emailStatus.value = 'error'
    }
  }
}
```

2. å‰ç«¯é€šçŸ¥åå¥½è¨­å®šçµ„ä»¶
```vue
<!-- components/NotificationSettings.vue -->
<template>
  <div class="notification-settings">
    <h3>é€šçŸ¥è¨­å®š</h3>
    
    <div class="form-group">
      <label>
        <input type="checkbox" v-model="preferences.browser" />
        æ¥æ”¶ç€è¦½å™¨æ¡Œé¢é€šçŸ¥
      </label>
    </div>
    
    <div class="form-group">
      <label>
        <input type="checkbox" v-model="preferences.email" />
        æ¥æ”¶é›»å­éƒµä»¶æé†’
      </label>
    </div>
    
    <div class="form-group" v-if="preferences.email">
      <label>é›»å­éƒµä»¶åœ°å€</label>
      <input type="email" v-model="emailAddress" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶" />
      <button @click="testEmail" :disabled="!isValidEmail">æ¸¬è©¦é›»å­éƒµä»¶</button>
      <p v-if="emailMessage" class="email-message" :class="emailStatus">{{ emailMessage }}</p>
    </div>
    
    <div class="form-group">
      <label>æª¢æŸ¥é »ç‡ (ç§’)</label>
      <select v-model="preferences.pollingInterval">
        <option :value="10000">10 ç§’</option>
        <option :value="30000">30 ç§’</option>
        <option :value="60000">1 åˆ†é˜</option>
        <option :value="300000">5 åˆ†é˜</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>æå‰æé†’æ™‚é–“ (åˆ†é˜)</label>
      <select v-model="preferences.emailLeadTime">
        <option :value="15">15 åˆ†é˜</option>
        <option :value="30">30 åˆ†é˜</option>
        <option :value="60">1 å°æ™‚</option>
        <option :value="1440">1 å¤©</option>
      </select>
    </div>
    
    <div class="actions">
      <button class="primary" @click="saveSettings">å„²å­˜è¨­å®š</button>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { NotificationService } from '@/services/notificationService'

const authStore = useAuthStore()
const notificationService = new NotificationService()

const preferences = reactive({
  browser: true,
  email: true,
  pollingInterval: 30000,
  emailLeadTime: 60
})

const emailAddress = ref('')
const emailMessage = ref('')
const emailStatus = ref('')

// è¼‰å…¥ç¾æœ‰è¨­å®š
onMounted(() => {
  const savedPrefs = notificationService.loadPreferences()
  Object.assign(preferences, savedPrefs)
  
  if (authStore.user?.email) {
    emailAddress.value = authStore.user.email
  }
})

const isValidEmail = computed(() => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  return emailRegex.test(emailAddress.value)
})

async function testEmail() {
  if (!isValidEmail.value) return
  
  try {
    emailMessage.value = 'æ­£åœ¨ç™¼é€æ¸¬è©¦éƒµä»¶...'
    emailStatus.value = 'pending'
    
    await notificationService.testEmail(emailAddress.value)
    
    emailMessage.value = 'æ¸¬è©¦éƒµä»¶å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥æ‚¨çš„éƒµç®±'
    emailStatus.value = 'success'
  } catch (error) {
    emailMessage.value = `ç™¼é€å¤±æ•—: ${error.message}`
    emailStatus.value = 'error'
  }
}

function saveSettings() {
  // å„²å­˜é›»å­éƒµä»¶
  if (preferences.email && isValidEmail.value) {
    authStore.updateUserEmail(emailAddress.value)
  }
  
  // å„²å­˜é€šçŸ¥åå¥½
  notificationService.savePreferences(preferences)
  
  // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
  alert('é€šçŸ¥è¨­å®šå·²å„²å­˜')
}
</script>

<style scoped>
.notification-settings {
  max-width: 500px;
  margin: 0 auto;
}

.form-group {
  margin-bottom: 16px;
}

.email-message {
  font-size: 14px;
  margin-top: 4px;
}

.email-message.pending {
  color: #2196F3;
}

.email-message.success {
  color: #4CAF50;
}

.email-message.error {
  color: #F44336;
}

button.primary {
  background-color: #2196F3;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}
</style>
```

3. å¾Œç«¯ API å¯¦ä½œ (CodeIgniter)

```php
// app/Controllers/Notifications.php
<?php

namespace App\Controllers;

use CodeIgniter\RESTful\ResourceController;
use CodeIgniter\API\ResponseTrait;
use App\Models\CardModel;
use App\Models\UserModel;
use App\Models\NotificationModel;

class Notifications extends ResourceController
{
  use ResponseTrait;
  
  protected function setCorsHeaders()
  {
    // å–å¾—å‰ç«¯ä¾†æº
    $origin = $this->request->getHeaderLine('Origin');
    if (empty($origin)) {
      $origin = '*';
    }
    
    // è¨­å®š CORS æ¨™é ­
    $this->response->setHeader('Access-Control-Allow-Origin', $origin);
    $this->response->setHeader('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
    $this->response->setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    $this->response->setHeader('Access-Control-Allow-Credentials', 'true');
    $this->response->setHeader('Access-Control-Max-Age', '86400');
  }
  
  /**
   * ç²å–å³å°‡åˆ°æœŸä»»å‹™
   */
  public function upcoming()
  {
    $this->setCorsHeaders();
    
    // å¾ token ç²å–ç”¨æˆ¶ ID (ç°¡åŒ–ç¤ºä¾‹)
    $userId = 1; // å¯¦éš›æ‡‰ç”¨ä¸­å¾ JWT æˆ– session ç²å–
    $minutes = $this->request->getGet('minutes') ?? 30; // æœªä¾† 30 åˆ†é˜å…§åˆ°æœŸçš„ä»»å‹™
    
    $model = new CardModel();
    $tasks = $model->getUpcomingTasks($userId, $minutes);
    
    return $this->respond([
      'status' => 'success',
      'data' => $tasks
    ]);
  }
  
  /**
   * æ›´æ–°é€šçŸ¥è¨­å®š
   */
  public function settings()
  {
    $this->setCorsHeaders();
    
    // å¾ token ç²å–ç”¨æˆ¶ ID (ç°¡åŒ–ç¤ºä¾‹)
    $userId = 1; // å¯¦éš›æ‡‰ç”¨ä¸­å¾ JWT æˆ– session ç²å–
    $data = $this->request->getJSON(true);
    
    $userModel = new UserModel();
    $notificationModel = new NotificationModel();
    
    // æ›´æ–°ç”¨æˆ¶é€šçŸ¥è¨­å®š
    $notificationModel->updateSettings($userId, [
      'browser_enabled' => $data['browser'] ?? true,
      'email_enabled' => $data['email'] ?? true,
      'polling_interval' => $data['pollingInterval'] ?? 30000,
      'email_lead_time' => $data['emailLeadTime'] ?? 60
    ]);
    
    return $this->respond([
      'status' => 'success',
      'message' => 'é€šçŸ¥è¨­å®šå·²æ›´æ–°'
    ]);
  }
  
  /**
   * æ¸¬è©¦é›»å­éƒµä»¶ç™¼é€
   */
  public function testEmail()
  {
    $this->setCorsHeaders();
    
    $data = $this->request->getJSON(true);
    $email = $data['email'] ?? '';
    
    if (empty($email) || !filter_var($email, FILTER_VALIDATE_EMAIL)) {
      return $this->respond([
        'status' => 'error',
        'message' => 'è«‹æä¾›æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€'
      ], 400);
    }
    
    // ç™¼é€æ¸¬è©¦éƒµä»¶
    $emailService = \Config\Services::email();
    
    $emailService->setFrom('noreply@trelloclone.com', 'Trello Clone');
    $emailService->setTo($email);
    $emailService->setSubject('æ¸¬è©¦é€šçŸ¥ - Trello Clone');
    $emailService->setMessage('é€™æ˜¯ä¸€å°æ¸¬è©¦éƒµä»¶ï¼Œç¢ºèªæ‚¨çš„ Trello Clone é€šçŸ¥åŠŸèƒ½æ­£å¸¸é‹ä½œã€‚');
    
    if ($emailService->send()) {
      return $this->respond([
        'status' => 'success',
        'message' => 'æ¸¬è©¦éƒµä»¶å·²ç™¼é€'
      ]);
    } else {
      return $this->respond([
        'status' => 'error',
        'message' => 'éƒµä»¶ç™¼é€å¤±æ•—: ' . $emailService->printDebugger(['headers'])
      ], 500);
    }
  }
}
```

4. å¡ç‰‡æ¨¡å‹æ“´å±• (ç”¨æ–¼æª¢æŸ¥å³å°‡åˆ°æœŸä»»å‹™)
```php
// app/Models/CardModel.php (æ“´å±•ç¾æœ‰æ¨¡å‹)
public function getUpcomingTasks($userId, $minutes) {
  $now = date('Y-m-d H:i:s');
  $future = date('Y-m-d H:i:s', strtotime("+{$minutes} minutes"));
  
  return $this->db->table('cards c')
    ->select('c.id, c.title, c.deadline, l.title as list_title, b.id as board_id')
    ->join('lists l', 'l.id = c.list_id')
    ->join('boards b', 'b.id = l.board_id')
    ->where('b.user_id', $userId)
    ->where('c.deadline >=', $now)
    ->where('c.deadline <=', $future)
    ->get()
    ->getResultArray();
}
```

5. é€šçŸ¥è¨­å®šæ¨¡å‹ (æ–°å»º)
```php
// app/Models/NotificationModel.php
<?php

namespace App\Models;

use CodeIgniter\Model;

class NotificationModel extends Model
{
  protected $table = 'notification_settings';
  protected $primaryKey = 'user_id';
  protected $useAutoIncrement = false;
  protected $returnType = 'array';
  protected $useSoftDeletes = false;
  protected $allowedFields = ['user_id', 'browser_enabled', 'email_enabled', 'polling_interval', 'email_lead_time', 'last_email_sent'];
  protected $useTimestamps = true;
  protected $createdField = 'created_at';
  protected $updatedField = 'updated_at';
  
  public function updateSettings($userId, $settings)
  {
    // æª¢æŸ¥è¨­å®šæ˜¯å¦å­˜åœ¨
    $existingSettings = $this->find($userId);
    
    if ($existingSettings) {
      // æ›´æ–°ç¾æœ‰è¨­å®š
      $this->update($userId, $settings);
    } else {
      // å‰µå»ºæ–°è¨­å®š
      $settings['user_id'] = $userId;
      $this->insert($settings);
    }
    
    return true;
  }
  
  public function getUsersForEmailNotification($leadTimeMinutes = 60)
  {
    $now = date('Y-m-d H:i:s');
    $targetTime = date('Y-m-d H:i:s', strtotime("+{$leadTimeMinutes} minutes"));
    
    // ç²å–éœ€è¦ç™¼é€éƒµä»¶çš„ç”¨æˆ¶å’Œä»»å‹™
    return $this->db->table('notification_settings ns')
      ->select('u.id, u.email, u.name, c.id as card_id, c.title, c.deadline, l.title as list_title, b.id as board_id')
      ->join('users u', 'u.id = ns.user_id')
      ->join('boards b', 'b.user_id = u.id')
      ->join('lists l', 'l.board_id = b.id')
      ->join('cards c', 'c.list_id = l.id')
      ->where('ns.email_enabled', 1)
      ->where('u.email IS NOT NULL')
      ->where('c.deadline >', $now)
      ->where('c.deadline <', $targetTime)
      ->where("(ns.last_email_sent IS NULL OR DATE_ADD(ns.last_email_sent, INTERVAL 1 HOUR) < NOW())")
      ->get()
      ->getResultArray();
  }
  
  public function updateLastEmailSent($userId)
  {
    return $this->update($userId, [
      'last_email_sent' => date('Y-m-d H:i:s')
    ]);
  }
}
```

6. é›»å­éƒµä»¶é€šçŸ¥æ’ç¨‹å‘½ä»¤

```php
// app/Commands/SendNotifications.php
<?php

namespace App\Commands;

use CodeIgniter\CLI\BaseCommand;
use CodeIgniter\CLI\CLI;
use App\Models\NotificationModel;

class SendNotifications extends BaseCommand
{
  protected $group = 'Notifications';
  protected $name = 'notifications:send';
  protected $description = 'ç™¼é€ä»»å‹™åˆ°æœŸé›»å­éƒµä»¶é€šçŸ¥';
  
  public function run(array $params)
  {
    $notificationModel = new NotificationModel();
    $emailService = \Config\Services::email();
    
    // ç²å–æ‰€æœ‰éœ€è¦ç™¼é€éƒµä»¶çš„ç”¨æˆ¶å’Œä»»å‹™
    $notifications = $notificationModel->getUsersForEmailNotification();
    
    if (empty($notifications)) {
      CLI::write('æ²’æœ‰éœ€è¦ç™¼é€çš„é€šçŸ¥', 'yellow');
      return;
    }
    
    CLI::write('é–‹å§‹ç™¼é€ ' . count($notifications) . ' å€‹é€šçŸ¥...', 'green');
    
    $successCount = 0;
    $errorCount = 0;
    
    // æŒ‰ç”¨æˆ¶åˆ†çµ„
    $groupedNotifications = [];
    foreach ($notifications as $notification) {
      $userId = $notification['id'];
      if (!isset($groupedNotifications[$userId])) {
        $groupedNotifications[$userId] = [
          'user' => [
            'id' => $userId,
            'email' => $notification['email'],
            'name' => $notification['name']
          ],
          'tasks' => []
        ];
      }
      
      $groupedNotifications[$userId]['tasks'][] = [
        'id' => $notification['card_id'],
        'title' => $notification['title'],
        'deadline' => $notification['deadline'],
        'list_title' => $notification['list_title'],
        'board_id' => $notification['board_id']
      ];
    }
    
    // å‘æ¯å€‹ç”¨æˆ¶ç™¼é€ä¸€å°åŒ…å«å¤šå€‹ä»»å‹™çš„éƒµä»¶
    foreach ($groupedNotifications as $userId => $userData) {
      $user = $userData['user'];
      $tasks = $userData['tasks'];
      
      // æ§‹å»ºéƒµä»¶å…§å®¹
      $message = "è¦ªæ„›çš„ {$user['name']},\n\n";
      $message .= "æ‚¨æœ‰ä»¥ä¸‹ä»»å‹™å³å°‡åˆ°æœŸï¼š\n\n";
      
      foreach ($tasks as $task) {
        $deadline = date('Y/m/d H:i', strtotime($task['deadline']));
        $message .= "- {$task['title']} (åœ¨ {$task['list_title']} æ¸…å–®ä¸­)\n";
        $message .= "  æˆªæ­¢æ™‚é–“ï¼š{$deadline}\n\n";
      }
      
      $message .= "è«‹åŠæ™‚è™•ç†é€™äº›ä»»å‹™ã€‚\n\n";
      $message .= "æ­¤è‡´,\næ‚¨çš„ Trello Clone åœ˜éšŠ";
      
      // ç™¼é€éƒµä»¶
      $emailService->clear();
      $emailService->setFrom('noreply@trelloclone.com', 'Trello Clone');
      $emailService->setTo($user['email']);
      $emailService->setSubject('ä»»å‹™å³å°‡åˆ°æœŸæé†’ - Trello Clone');
      $emailService->setMessage($message);
      
      if ($emailService->send()) {
        $successCount++;
        // æ›´æ–°æœ€å¾Œç™¼é€æ™‚é–“
        $notificationModel->updateLastEmailSent($userId);
        CLI::write("æˆåŠŸç™¼é€éƒµä»¶çµ¦ {$user['email']}", 'green');
      } else {
        $errorCount++;
        CLI::write("ç™¼é€éƒµä»¶å¤±æ•— {$user['email']}: " . $emailService->printDebugger(['headers']), 'red');
      }
    }
    
    CLI::write("ç™¼é€å®Œæˆ: {$successCount} æˆåŠŸ, {$errorCount} å¤±æ•—", 'yellow');
  }
}
```

7. é€šçŸ¥è¨­å®šæ•¸æ“šè¡¨å‰µå»º (é·ç§»æª”æ¡ˆ)

```php
// app/Database/Migrations/yyyy-mm-dd-hhiiss_CreateNotificationSettings.php
<?php

namespace App\Database\Migrations;

use CodeIgniter\Database\Migration;

class CreateNotificationSettings extends Migration
{
  public function up()
  {
    $this->forge->addField([
      'user_id' => [
        'type' => 'INT',
        'constraint' => 11,
        'unsigned' => true,
      ],
      'browser_enabled' => [
        'type' => 'TINYINT',
        'constraint' => 1,
        'default' => 1,
      ],
      'email_enabled' => [
        'type' => 'TINYINT',
        'constraint' => 1,
        'default' => 1,
      ],
      'polling_interval' => [
        'type' => 'INT',
        'constraint' => 11,
        'default' => 30000,
      ],
      'email_lead_time' => [
        'type' => 'INT',
        'constraint' => 11,
        'default' => 60,
      ],
      'last_email_sent' => [
        'type' => 'DATETIME',
        'null' => true,
      ],
      'created_at' => [
        'type' => 'DATETIME',
        'null' => true,
      ],
      'updated_at' => [
        'type' => 'DATETIME',
        'null' => true,
      ],
    ]);
    
    $this->forge->addKey('user_id', true);
    $this->forge->createTable('notification_settings');
  }
  
  public function down()
  {
    $this->forge->dropTable('notification_settings');
  }
}
```

8. æ•´åˆåˆ° Vue æ‡‰ç”¨ç¨‹å¼
```javascript
// main.js æˆ– App.vue
import { NotificationService } from '@/services/notificationService'
import { useAuthStore } from '@/stores/auth'

const authStore = useAuthStore()
const notificationService = new NotificationService()

// ç•¶ç”¨æˆ¶ç™»å…¥å¾Œå•Ÿå‹•é€šçŸ¥æœå‹™
watchEffect(() => {
  if (authStore.isAuthenticated) {
    notificationService.startPolling()
  } else {
    notificationService.stopPolling()
  }
})

// åœ¨ App.vue çš„ onUnmounted ä¸­åœæ­¢é€šçŸ¥æœå‹™
onUnmounted(() => {
  notificationService.stopPolling()
})
```

9. è¨­å®šæ’ç¨‹ä»»å‹™ (Cron Job)

å¯ä»¥ä½¿ç”¨ CodeIgniter 4 çš„ä»»å‹™æ’ç¨‹åŠŸèƒ½ï¼Œåœ¨ `app/Config/Tasks.php` ä¸­è¨­å®šï¼š

```php
$tasks->schedule('æ¯å°æ™‚æª¢æŸ¥åˆ°æœŸä»»å‹™ä¸¦ç™¼é€éƒµä»¶é€šçŸ¥', function() {
  $this->call(function() {
    command('notifications:send');
  });
})->hourly();
```

æˆ–è€…è¨­å®š server çš„ Cron Jobï¼š

```
0 * * * * php /path/to/project/public/index.php notifications:send
```

ğŸ”® æœªä¾†å±•æœ›ï¼ˆè‹¥å•†æ¥­åŒ–æ™‚ï¼‰
1. å°å…¥ Firebase Cloud Messaging (FCM) ç­‰æ¨æ’­æœå‹™
2. å¾Œç«¯ä¸»å‹•ç™¼é€é€šçŸ¥ï¼Œå¯¦ç¾å³æ™‚æ€§é€šçŸ¥
3. ç®¡ç†è£ç½® Tokenã€è¨Šæ¯éšŠåˆ—ç­‰
4. æ”¯æ´ Web Pushã€Mobile Push ç­‰å¤šç«¯åŒæ­¥
5. å¢åŠ æ›´å¤šé€šçŸ¥é¡å‹ï¼ˆå¦‚ï¼šè©•è«–ã€æåŠã€åˆ†äº«ç­‰ï¼‰
6. æ”¯æ´æ›´å¤šé€šçŸ¥é »é“ï¼ˆSlackã€Microsoft Teamsï¼‰

ğŸ“Œ ç·¨èªª
æœ¬è¨­è¨ˆä»¥ã€Œæœ€å°å¯è¡Œç”¢å“ (MVP)ã€ç‚ºå„ªå…ˆç›®æ¨™ï¼ŒåŒæ™‚æä¾›é›»å­éƒµä»¶æé†’åŠŸèƒ½ã€‚

é©åˆå°å‹ã€ä½æˆæœ¬ã€å¿«é€Ÿé–‹ç™¼é …ç›®ï¼Œä¸éœ€è¦è¤‡é›œçš„å¾Œç«¯åŸºç¤è¨­æ–½ã€‚

ä¸»è¦åŠŸèƒ½ï¼š
1. âœ… æ”¯æ´ç€è¦½å™¨åŸç”Ÿé€šçŸ¥
2. âœ… è‡ªå‹•æª¢æŸ¥å³å°‡åˆ°æœŸä»»å‹™
3. âš ï¸ é›»å­éƒµä»¶ä»»å‹™æé†’ï¼ˆç¨‹å¼ç¢¼å·²å¯¦ç¾ï¼Œå¾…éƒ¨ç½²å¾Œæ¸¬è©¦ï¼‰
4. ğŸ”„ é€šçŸ¥åå¥½è¨­å®š
